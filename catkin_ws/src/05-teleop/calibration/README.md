# Package `calibration` {#calibration}

<move-here src='#pkg_name-autogenerated'/>

**TO DO**
⁻ Gracefully stop rosbag recording in compressed_image_to_world_frame.launch, so far requires hard-kill via CTRL+C.
- Bug in compressed_image_to_world_frame: see issues.

**REQUIRED**:

To be able to run the launch file: compressed_image_to_world_frame.launch:

use local_env.sh which sets the DUCKIEFLEET_ROOT to the default location. Make sure to include your calibration folder at DUCKIEFLEET_ROOT.

Install the lastest version of the scipy, as the code uses `ivp_solver` that is introduced in scipy version v1.2.0

This package is an automatic wheels calibration procedure.

- The launchfile commands.launch sends specific voltage command to the wheels while recording images with the camera in a rosbag.

- The launchfile calibration.launch calculates the different parameters of the theoretical model that fit best the trajectory of the Duckiebot.

- The launchfile test.launch tests if the calibration has succeed or not.


## Data Acquisition

Start camera-related functionality by roslaunching

```shell
roslaunch pi_camera camera_node.launch veh:=![ROBOT_NAME]
```

Then start the data-acquisition interface by

```shell
roslaunch calibration data_collector.launch veh:=![ROBOT_NAME] param_file_name:=![PARAM_FILE]
```
With this interface can specify

- the type of the experiment you would like to conduct by choosing amongst the presented options,

- whether to save the collected experiment data by answering the question after the experiment has been completed,

- whether to do another experiment.

Note that we can specisify the resolution of the images taken with ´![PARAM_FILE]´. This file must be placed under ´´

´$(duckietown)/config/baseline/pi_camera/camera_node´.

## Calibration  

### Processing Data

The data recorded during the experiment is /compressed_image, but calibration script requires /tag_detections_local_frame. To get a bag file with the correct topic.

```shell
roslaunch calibration compressed_image_to_world_frame.launch veh:=mete input_rosbag:=/home/selcuk/input.bag output_rosbag:=/home/selcuk/![OUTPUT_FILE_NAME].bag operation_mode:=1
```

Note the `operation_mode` parameters which runs the image processing pipeline in sequential mode.

Also note that image processing pipeline requires the calibration files to work correctly, currently the calibration files are look for in their default location, for instance intrinsic calibration file must be located at '![HOME_DIRECTORY]/duckiefleet/calibrations/camera_intrinsic/![ROBOT_NAME].yaml'.

### Optimization

On your local PC, start the optimization

```shell
roslaunch calibration calibration.launch veh:=![ROBOT_NAME] folder_path:=![INPUT_FOLDER_PATH]
```

 Note that the optimization script automatically loads and feeds all the bag files that are located inside ![INPUT_FOLDER_PATH].

## Transfer the calibration YAML files

```shell
scp /home/selcuk/duckiefleet/calibrations/kinematics/mete_kinematic_drive.yaml selcuk@mete:~/
sudo mv ~/mete_kinematic_drive.yaml /data/config/calibrations/kinematics/
```
## Test

Run the test script with
```shell
scp /home/selcuk/duckiefleet/calibrations/kinematics/mete_kinematic_drive.yaml selcuk@mete:~/
sudo mv ~/mete_kinematic_drive.yaml /data/config/calibrations/kinematics/
```
